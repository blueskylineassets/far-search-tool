<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAR Search Tool - Internal Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: linear-gradient(135deg, #0a0a14 0%, #12121e 50%, #0a0a14 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
        }

        h1 {
            font-size: 2.2rem;
            color: #64b4ff;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(100, 180, 255, 0.3);
        }

        .subtitle { color: #666; font-size: 0.9rem; }

        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(100, 180, 255, 0.1);
            border: 1px solid rgba(100, 180, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-indicator:hover {
            background: rgba(100, 180, 255, 0.2);
            border-color: #64b4ff;
        }

        .section-title {
            font-size: 1rem;
            color: #64b4ff;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .section-description {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(100, 180, 255, 0.4);
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            color: #999;
            line-height: 1.5;
        }

        .section-description code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
            color: #64b4ff;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .section-description strong { color: #e0e0e0; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(100, 180, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: rgba(100, 180, 255, 0.4);
            transform: translateY(-2px);
        }

        .stat-card.highlight {
            border-color: rgba(100, 180, 255, 0.5);
            background: rgba(100, 180, 255, 0.05);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #64b4ff;
        }

        .stat-detail {
            font-size: 0.7rem;
            color: #666;
            margin-top: 5px;
        }

        section { margin-bottom: 40px; }

        /* Customer Table */
        .customer-table-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .customer-table th {
            text-align: left;
            padding: 12px 15px;
            background: rgba(100, 180, 255, 0.05);
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
        }

        .customer-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .customer-table th.sortable:hover {
            color: #64b4ff;
            background: rgba(100, 180, 255, 0.1);
        }

        .customer-table th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.3;
            font-size: 0.8em;
        }

        .customer-table th.sortable.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
            color: #64b4ff;
        }

        .customer-table th.sortable.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
            color: #64b4ff;
        }

        .customer-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        .customer-table tr:hover { background: rgba(100, 180, 255, 0.03); }

        .customer-name { font-weight: 600; color: #64b4ff; }
        .customer-email { color: #666; font-size: 0.75rem; }

        .plan-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .plan-free { background: rgba(100, 180, 255, 0.2); color: #64b4ff; }
        .plan-pro { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .plan-ultra { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }

        .source-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            text-transform: lowercase;
            font-weight: 500;
        }

        .source-far-search-tool { background: rgba(100, 180, 255, 0.2); color: #64b4ff; }
        .source-far-oracle { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .source-direct { background: rgba(255, 255, 255, 0.1); color: #888; }

        .location-cell { font-size: 0.85rem; color: #ccc; }

        .status-active { color: #00ff88; }
        .status-trial { color: #ffc832; }

        /* Chart */
        .chart-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper { height: 250px; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading { animation: pulse 1.5s infinite; }

        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid rgba(100, 180, 255, 0.1);
            text-align: center;
            font-size: 0.75rem;
            color: #444;
        }

        footer a { color: #64b4ff; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö FAR Search Tool - Internal Dashboard</h1>
            <p class="subtitle">Real-time metrics for the FAR RAG ecosystem</p>
            <div class="refresh-indicator" onclick="loadAllData()">
                <span id="lastUpdated">Loading...</span>
                <span>üîÑ Refresh</span>
            </div>
        </header>

        <!-- SDK Activation Funnel -->
        <section>
            <h2 class="section-title">üìä FAR SDK Activation Funnel</h2>
            <div class="stats-grid" id="sdkFunnel">
                <div class="stat-card">
                    <div class="stat-label">PyPI Downloads/Month</div>
                    <div class="stat-value" id="totalDownloads">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">SDK Registrations</div>
                    <div class="stat-value" id="sdkRegistrations">0</div>
                    <div class="stat-detail" id="regConversion">0% from PyPI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Users</div>
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-detail" id="activeConversion">0% activation</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Queries This Month</div>
                    <div class="stat-value" id="queriesMonth">0</div>
                </div>
            </div>
        </section>

        <!-- FAR Package Downloads -->
        <section>
            <h2 class="section-title">üì¶ FAR Package Downloads (Monthly)</h2>
            <p class="section-description">
                ‚ö†Ô∏è <strong>What this means:</strong> Anyone who ran <code>pip install</code>.
                Includes CI/CD bots, mirrors, and people testing locally.
                <strong>Does NOT require registration.</strong>
            </p>
            <div id="packageDownloads" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="loading">Loading PyPI data...</div>
            </div>
        </section>

        <!-- Registration Sources -->
        <section>
            <h2 class="section-title">üìà Registration Sources</h2>
            <div id="regSourcesList" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="loading">Loading registration data...</div>
            </div>
        </section>

        <!-- PyPI Downloads (Legacy - for chart) -->
        <section style="display: none;">
            <div class="stats-grid" id="pypiDownloads"></div>
        </section>

        <!-- Registered Customers -->
        <section>
            <h2 class="section-title">üë• Registered Customers ‚Äî Active vs Registered</h2>
            <p class="section-description">
                <strong>Key metrics:</strong><br>
                ‚úÖ <strong>Active Users</strong> ‚Äî Users who have made at least 1 API query (your goal metric)<br>
                üìù <strong>Registered</strong> ‚Äî Total API key holders<br>
                üîß <strong>Test</strong> ‚Äî Your internal tests (hidden from metrics)
            </p>
            <div class="stats-grid" id="customerMetrics">
                <div class="loading">Loading metrics...</div>
            </div>
        </section>

        <!-- Customer Details -->
        <section>
            <h3 class="section-title">üìã Customer Details</h3>
            <div class="customer-table-container">
                <table class="customer-table" id="customerTable">
                    <thead>
                        <tr>
                            <th>Agent/Company</th>
                            <th>Source</th>
                            <th>Location</th>
                            <th>Plan</th>
                            <th class="sortable sort-desc" data-sort="usage" onclick="sortCustomers('usage')">Usage</th>
                            <th class="sortable" data-sort="date" onclick="sortCustomers('date')">Registered</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <tr><td colspan="6" class="loading">Loading customers...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Conversion Funnel -->
        <section>
            <h2 class="section-title">üîÑ Conversion Funnel ‚Äî Downloads ‚Üí Customers ‚Üí Usage</h2>
            <p class="section-description">
                üìä <strong>How to read this:</strong> Downloads are <em>awareness</em>,
                Registrations are <em>activation</em>, Queries are <em>engagement</em>.
            </p>
            <div class="stats-grid" id="conversionFunnel">
                <div class="loading">Loading funnel data...</div>
            </div>
        </section>

        <!-- Download Trends -->
        <section>
            <h2 class="section-title">üìà Download Trends (7 Days)</h2>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="downloadChart"></canvas>
                </div>
            </div>
        </section>

        <!-- API Usage -->
        <section>
            <h2 class="section-title">üìä API Usage & Queries</h2>
            <div class="stats-grid" id="apiUsage">
                <div class="loading">Loading usage data...</div>
            </div>
        </section>

        <footer>
            <a href="https://pypi.org/project/far-search-tool/" target="_blank">PyPI</a>
            <span style="color: rgba(255,255,255,0.2);">|</span>
            <a href="https://github.com/blueskylineassets/far-search-tool" target="_blank">GitHub</a>
            <span style="color: rgba(255,255,255,0.2);">|</span>
            <a href="https://rapidapi.com/yschang/api/far-rag-federal-acquisition-regulation-search" target="_blank">RapidAPI</a>
            <br><br>
            FAR Search Tool ¬© 2024. All rights reserved.
        </footer>
    </div>

    <script>
        const API_URL = 'https://far-rag-api-production.up.railway.app';
        
        // Admin API key - stored in sessionStorage for security
        // Set via: sessionStorage.setItem('adminKey', 'your-key-here')
        const ADMIN_KEY = sessionStorage.getItem('adminKey') || prompt('Enter admin API key:');
        if (ADMIN_KEY) {
            sessionStorage.setItem('adminKey', ADMIN_KEY);
        }
        
        // Helper function to add admin auth header
        function getAdminHeaders() {
            return {
                'X-Admin-Key': ADMIN_KEY
            };
        }
        
        let downloadChart = null;

        async function loadAllData() {
            document.getElementById('lastUpdated').textContent = 'Refreshing...';
            
            try {
                await Promise.all([
                    loadPyPIStats(),
                    loadCustomerMetrics(),
                    loadCustomers(),
                    loadApiUsage()
                ]);
                
                // Update conversion funnel AFTER all data is loaded
                // (depends on window.totalCustomers from loadCustomerMetrics 
                // and window.pypiDownloads from loadPyPIStats)
                updateConversionFunnel(window.pypiDownloads || 0);
                
                document.getElementById('lastUpdated').textContent = 
                    `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('Failed to load data:', e);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            }
        }

        async function loadPyPIStats() {
            try {
                // Fetch funnel metrics (includes PyPI, registrations, active users)
                const funnelResponse = await fetch(`${API_URL}/v1/funnel-metrics`, {
                    headers: getAdminHeaders()
                });
                if (!funnelResponse.ok) throw new Error('Funnel metrics failed');
                
                const data = await funnelResponse.json();
                
                // Update SDK Activation Funnel stats
                document.getElementById('totalDownloads').textContent = 
                    (data.pypi_downloads?.monthly || 0).toLocaleString();
                document.getElementById('sdkRegistrations').textContent = 
                    (data.registrations?.total || 0).toLocaleString();
                document.getElementById('activeUsers').textContent = 
                    (data.active_users?.total || 0).toLocaleString();
                document.getElementById('queriesMonth').textContent = 
                    (data.queries?.this_month || 0).toLocaleString();
                
                // Update conversion rates
                document.getElementById('regConversion').textContent = 
                    `${data.conversions?.pypi_to_register || 0}% from PyPI`;
                document.getElementById('activeConversion').textContent = 
                    `${data.conversions?.register_to_active || 0}% activation`;
                
                // Update FAR Package Downloads breakdown
                const packagesList = document.getElementById('packageDownloads');
                const packages = data.pypi_downloads?.packages || {};
                const packageLabels = {
                    'far-search-tool': 'üîó FAR Search Tool',
                    'far-oracle': 'üñ•Ô∏è FAR Oracle (MCP)',
                    'far-search': 'üì¶ FAR Search Core',
                    'far-search-autogpt': 'ü§ñ FAR AutoGPT',
                    'far-search-crewai': 'üë• FAR CrewAI'
                };
                if (Object.keys(packages).length > 0) {
                    packagesList.innerHTML = Object.entries(packages)
                        .sort((a, b) => (b[1]?.month || 0) - (a[1]?.month || 0))
                        .map(([pkg, stats]) => `
                            <div style="background: rgba(100,180,255,0.1); border: 1px solid rgba(100,180,255,0.3); 
                                        padding: 10px 15px; border-radius: 6px; min-width: 120px;">
                                <div style="color: #64b4ff; font-weight: bold; font-size: 1.5rem;">
                                    ${(stats?.month || 0).toLocaleString()}
                                </div>
                                <div style="color: #888; font-size: 0.8rem; margin-top: 4px;">
                                    ${packageLabels[pkg] || pkg}
                                </div>
                            </div>
                        `).join('');
                } else {
                    packagesList.innerHTML = '<span style="color: #666;">No download data</span>';
                }
                
                // Update Registration Sources
                const sourcesList = document.getElementById('regSourcesList');
                const sources = data.registrations?.by_source || {};
                if (Object.keys(sources).length > 0) {
                    sourcesList.innerHTML = Object.entries(sources)
                        .sort((a, b) => b[1] - a[1])
                        .map(([source, count]) => `
                            <div style="background: rgba(100,180,255,0.1); border: 1px solid rgba(100,180,255,0.3); 
                                        padding: 10px 15px; border-radius: 6px;">
                                <span style="color: #64b4ff; font-weight: bold;">${count}</span>
                                <span style="color: #888; margin-left: 8px;">${source || 'direct'}</span>
                            </div>
                        `).join('');
                } else {
                    sourcesList.innerHTML = '<span style="color: #666;">No registrations yet</span>';
                }
                
                // Load daily data for the trends chart
                loadDailyDownloads();
                
                // Store downloads for funnel (called after all data loads)
                window.pypiDownloads = data.pypi_downloads?.monthly || 0;
                
            } catch (e) {
                console.error('PyPI/Funnel stats error:', e);
                document.getElementById('packageDownloads').innerHTML = 
                    '<span style="color: #666;">Failed to load package data</span>';
            }
        }

        async function loadDailyDownloads() {
            try {
                const response = await fetch(`${API_URL}/v1/pypi-stats/daily`, {
                    headers: getAdminHeaders()
                });
                if (!response.ok) throw new Error('Daily stats failed');
                
                const data = await response.json();
                renderDownloadChart(data);
            } catch (e) {
                console.error('Failed to load daily downloads:', e);
                // Show placeholder message in chart area
                const ctx = document.getElementById('downloadChart');
                if (ctx) {
                    ctx.parentElement.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">Daily download data loading...</div>';
                }
            }
        }

        function renderDownloadChart(dailyData) {
            const ctx = document.getElementById('downloadChart');
            if (!ctx) return;
            
            // Destroy existing chart if any
            if (downloadChart) {
                downloadChart.destroy();
            }
            
            // Use actual daily data for the last 7 days
            const labels = dailyData.labels || [];
            const searchToolData = dailyData.packages?.['far-search-tool'] || [];
            const oracleData = dailyData.packages?.['far-oracle'] || [];
            
            downloadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'far-search-tool',
                            data: searchToolData,
                            borderColor: 'rgba(100, 180, 255, 1)',
                            backgroundColor: 'rgba(100, 180, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(100, 180, 255, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'far-oracle',
                            data: oracleData,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#888',
                                font: { size: 11 },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#64b4ff',
                            bodyColor: '#e0e0e0',
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} downloads`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#666' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#666',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });
        }

        async function loadCustomerMetrics() {
            try {
                // Fetch both count and list to calculate active users
                const [countResponse, listResponse] = await Promise.all([
                    fetch(`${API_URL}/v1/customers/count`, { headers: getAdminHeaders() }),
                    fetch(`${API_URL}/v1/customers/list`, { headers: getAdminHeaders() })
                ]);
                
                if (!countResponse.ok) throw new Error('Customer count failed');
                
                const countData = await countResponse.json();
                const test = countData.test || 0;
                const total = countData.count || 0;
                const registered = total - test;  // Exclude test accounts
                
                // Calculate active users from customer list
                let activeUsers = 0;
                if (listResponse.ok) {
                    const listData = await listResponse.json();
                    const customers = listData.customers || [];
                    activeUsers = customers.filter(c => 
                        c.account_type !== 'test' && 
                        (c.queries_used_this_month || 0) > 0
                    ).length;
                }
                
                const activationRate = registered > 0 ? ((activeUsers / registered) * 100).toFixed(0) : 0;
                
                document.getElementById('customerMetrics').innerHTML = `
                    <div class="stat-card highlight">
                        <div class="stat-label">‚úÖ Active Users</div>
                        <div class="stat-value" style="color: #00ff88;">${activeUsers}</div>
                        <div class="stat-detail">Made at least 1 query</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìù Registered</div>
                        <div class="stat-value" style="color: #64b4ff;">${registered}</div>
                        <div class="stat-detail">${activationRate}% activation rate</div>
                    </div>
                    <div class="stat-card" style="opacity: 0.5;">
                        <div class="stat-label">üîß Test</div>
                        <div class="stat-value" style="color: #888;">${test}</div>
                        <div class="stat-detail">Hidden from metrics</div>
                    </div>
                `;
                
                // Store for funnel (exclude test)
                window.totalCustomers = registered;
                window.activeUsers = activeUsers;
                
            } catch (e) {
                console.error('Customer metrics error:', e);
            }
        }

        // Global state for customer sorting
        let customerData = [];
        let customerSortColumn = 'usage';
        let customerSortDirection = 'desc';

        function sortCustomers(column) {
            // Toggle direction if same column, otherwise default to desc
            if (customerSortColumn === column) {
                customerSortDirection = customerSortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                customerSortColumn = column;
                customerSortDirection = 'desc';
            }
            
            // Update header classes
            document.querySelectorAll('.customer-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(customerSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Re-render with new sort
            renderCustomerTable();
        }

        function renderCustomerTable() {
            const tbody = document.getElementById('customerTableBody');
            
            if (!customerData || customerData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No customers yet</td></tr>';
                return;
            }
            
            // Sort based on current settings
            const sorted = [...customerData].sort((a, b) => {
                let comparison = 0;
                
                if (customerSortColumn === 'usage') {
                    const aUsage = a.queries_used_this_month || 0;
                    const bUsage = b.queries_used_this_month || 0;
                    comparison = bUsage - aUsage;
                } else if (customerSortColumn === 'date') {
                    comparison = new Date(b.created_at) - new Date(a.created_at);
                }
                
                // Secondary sort
                if (comparison === 0) {
                    if (customerSortColumn === 'usage') {
                        comparison = new Date(b.created_at) - new Date(a.created_at);
                    } else {
                        comparison = (b.queries_used_this_month || 0) - (a.queries_used_this_month || 0);
                    }
                }
                
                return customerSortDirection === 'asc' ? -comparison : comparison;
            });
            
            tbody.innerHTML = sorted.map(c => {
                const source = c.registration_source || 'direct';
                const sourceClass = `source-${source.replace(/[^a-z-]/gi, '-')}`;
                const planClass = `plan-${(c.plan || 'free').toLowerCase()}`;
                const accountType = c.account_type || 'trial';
                const opacity = accountType === 'test' ? '0.5' : '1';
                
                const registered = new Date(c.created_at).toLocaleDateString();
                const usage = c.queries_used_this_month || 0;
                const limit = c.queries_per_month || 500;
                
                // Location display
                const flag = c.flag || 'üåç';
                const location = c.location || 'Unknown';
                
                // Activity badge based on usage
                const isActive = usage > 0;
                const accountBadge = accountType === 'test'
                    ? '<span style="background:rgba(100,100,100,0.2);color:#666;font-size:0.6rem;padding:2px 6px;border-radius:3px;margin-left:8px;">üîß Test</span>'
                    : isActive
                    ? '<span style="background:rgba(0,255,136,0.2);color:#00ff88;font-size:0.6rem;padding:2px 6px;border-radius:3px;margin-left:8px;">‚úÖ Active</span>'
                    : '<span style="background:rgba(100,180,255,0.2);color:#64b4ff;font-size:0.6rem;padding:2px 6px;border-radius:3px;margin-left:8px;">üìù Registered</span>';
                
                return `
                    <tr style="opacity: ${opacity};">
                        <td>
                            <div class="customer-name">${escapeHtml(c.agent_id || c.company_name || 'Unknown')}${accountBadge}</div>
                            <div class="customer-email">${escapeHtml(c.email || '')}</div>
                        </td>
                        <td><span class="source-badge ${sourceClass}">${source}</span></td>
                        <td><span class="location-cell">${flag} ${escapeHtml(location)}</span></td>
                        <td><span class="plan-badge ${planClass}">${c.plan || 'free'}</span></td>
                        <td>${usage}/${limit}</td>
                        <td>${registered}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadCustomers() {
            try {
                const response = await fetch(`${API_URL}/v1/customers/list`, {
                    headers: getAdminHeaders()
                });
                if (!response.ok) {
                    document.getElementById('customerTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #888;">üìä Customer details endpoint deploying...</td></tr>';
                    return;
                }
                
                const data = await response.json();
                customerData = data.customers || [];
                
                renderCustomerTable();
                
            } catch (e) {
                console.warn('Customer list not available yet:', e.message);
                document.getElementById('customerTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: #888;">üìä Customer details coming soon...</td></tr>';
            }
        }

        async function loadApiUsage() {
            try {
                const response = await fetch(`${API_URL}/v1/usage/stats`, {
                    headers: getAdminHeaders()
                });
                if (!response.ok) {
                    // Endpoint not deployed yet - show placeholder with customer count
                    const customers = window.totalCustomers || 0;
                    document.getElementById('apiUsage').innerHTML = `
                        <div class="stat-card highlight">
                            <div class="stat-label">Registered Users</div>
                            <div class="stat-value">${customers}</div>
                            <div class="stat-detail">Active API keys</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Queries Today</div>
                            <div class="stat-value">--</div>
                            <div class="stat-detail">Stats deploying...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Queries</div>
                            <div class="stat-value">--</div>
                            <div class="stat-detail">Coming soon</div>
                        </div>
                    `;
                    return;
                }
                
                const data = await response.json();
                
                document.getElementById('apiUsage').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Queries Today</div>
                        <div class="stat-value">${data.queries_today || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Queries This Month</div>
                        <div class="stat-value">${data.queries_this_month || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Queries</div>
                        <div class="stat-value">${data.total_queries || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active API Keys</div>
                        <div class="stat-value">${data.active_keys || 0}</div>
                    </div>
                `;
                
                // Store for funnel
                window.totalQueries = data.total_queries || 0;
                
            } catch (e) {
                console.warn('Usage stats not available yet:', e.message);
                const customers = window.totalCustomers || 0;
                document.getElementById('apiUsage').innerHTML = `
                    <div class="stat-card highlight">
                        <div class="stat-label">Registered Users</div>
                        <div class="stat-value">${customers}</div>
                        <div class="stat-detail">From /v1/customers/count</div>
                    </div>
                `;
            }
        }

        function updateConversionFunnel(downloads) {
            const registered = window.totalCustomers || 0;
            const activeUsers = window.activeUsers || 0;
            
            const regRate = downloads > 0 ? ((registered / downloads) * 100).toFixed(1) : 0;
            const activeRate = registered > 0 ? ((activeUsers / registered) * 100).toFixed(0) : 0;
            
            document.getElementById('conversionFunnel').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üì• Downloads</div>
                    <div class="stat-value">${downloads.toLocaleString()}</div>
                    <div class="stat-detail">Monthly installs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìù Registrations</div>
                    <div class="stat-value">${registered}</div>
                    <div class="stat-detail">${regRate}% conversion</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚úÖ Active Users</div>
                    <div class="stat-value">${activeUsers}</div>
                    <div class="stat-detail">${activeRate}% of registered</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
