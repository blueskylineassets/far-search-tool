<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAR RAG Analytics Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        h1 {
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1rem;
        }

        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 15px;
        }

        .refresh-indicator:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: border-color 0.3s, transform 0.2s;
        }

        .stat-card:hover {
            border-color: #00ff88;
            transform: translateY(-2px);
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: #00ff88;
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-value.small {
            font-size: 2rem;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 136, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .chart-title {
            color: #00ff88;
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .search-queries-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .query-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .query-list::-webkit-scrollbar {
            width: 8px;
        }

        .query-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .query-list::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 4px;
        }

        .query-item {
            background: rgba(0, 0, 0, 0.2);
            border-left: 3px solid #00ff88;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .query-text {
            color: #fff;
            font-size: 1rem;
            flex: 1;
        }

        .query-time {
            color: #888;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .query-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .query-location, .query-page {
            color: #666;
            font-size: 0.8rem;
        }
        
        .query-page {
            background: rgba(0, 255, 136, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
        }
        
        .event-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .event-icon {
            font-size: 1.2rem;
        }
        
        .event-type {
            color: #fff;
            font-weight: 600;
            text-transform: capitalize;
            min-width: 100px;
        }
        
        .event-page {
            background: rgba(0, 255, 136, 0.1);
            padding: 3px 10px;
            border-radius: 4px;
            color: #00ff88;
            font-size: 0.85rem;
        }
        
        .event-location {
            color: #888;
            font-size: 0.85rem;
        }
        
        .event-time {
            color: #666;
            font-size: 0.8rem;
            margin-left: auto;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #ff4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #00ff88;
        }

        .spinner {
            border: 3px solid rgba(0, 255, 136, 0.1);
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö FAR RAG - Internal Dashboard</h1>
            <p class="subtitle">PyPI downloads, registrations, and honeypot analytics</p>
            <div class="refresh-indicator" style="cursor: pointer;" onclick="fetchDashboardData()" title="Click to refresh">
                <span>üîÑ</span>
                <span id="refreshStatus">Click to refresh</span>
            </div>
            <p class="subtitle" style="margin-top: 10px; font-size: 0.8rem; color: #666;" id="timezoneInfo">
                Times shown in your local timezone
            </p>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading analytics data...</p>
        </div>

        <div id="error" class="error-message" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- PyPI Downloads Section -->
            <h3 style="color: #00ff88; margin-bottom: 15px;">üì¶ PyPI Downloads (FAR Tools)</h3>
            <div class="stats-grid">
                <div class="stat-card" style="border-color: rgba(100, 180, 255, 0.4);">
                    <div class="stat-label">far-search-tool (Week)</div>
                    <div class="stat-value" id="farSearchWeek" style="color: #64b4ff;">--</div>
                    <div style="color: #666; font-size: 0.8rem; margin-top: 5px;">LangChain Tool</div>
                </div>
                <div class="stat-card" style="border-color: rgba(59, 130, 246, 0.4);">
                    <div class="stat-label">far-oracle (Week)</div>
                    <div class="stat-value" id="farOracleWeek" style="color: #3b82f6;">--</div>
                    <div style="color: #666; font-size: 0.8rem; margin-top: 5px;">MCP Server</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Monthly</div>
                    <div class="stat-value small" id="totalMonthly">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Registered Users</div>
                    <div class="stat-value small" id="registeredUsers">--</div>
                </div>
            </div>
            
            <!-- Honeypot Stats Section -->
            <h3 style="color: #00ff88; margin-bottom: 15px; margin-top: 30px;">üçØ Honeypot Analytics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Unique Visitors Today</div>
                    <div class="stat-value" id="todayVisitors">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today's Searches</div>
                    <div class="stat-value" id="todaySearches">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CTA Clicks</div>
                    <div class="stat-value" id="todayClicks">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-value small" id="conversionRate">0%</div>
                </div>
            </div>

            <!-- 7-Day Trend Chart -->
            <div class="chart-section">
                <h2 class="chart-title">üìà 7-Day Visitor Trend</h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Event Breakdown Pie Chart -->
            <div class="chart-section">
                <h2 class="chart-title">üìä Today's Event Breakdown</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- Recent Search Queries -->
            <div class="search-queries-section">
                <h2 class="chart-title">üîç Recent Search Queries</h2>
                <div id="queryList" class="query-list"></div>
            </div>
            
            <!-- Recent Events -->
            <div class="search-queries-section">
                <h2 class="chart-title">üìä Recent Events (Today)</h2>
                <div id="eventList" class="event-list"></div>
            </div>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR ACTUAL RAILWAY API URL
        const API_URL = 'https://far-rag-api-production.up.railway.app';
        
        let trendChart = null;
        let pieChart = null;
        let lastUpdate = null;

        // Fetch and update dashboard data
        async function fetchDashboardData() {
            try {
                // Get user's timezone offset in minutes (negative for west of UTC)
                const tzOffset = -new Date().getTimezoneOffset();
                const response = await fetch(`${API_URL}/analytics/dashboard?tz_offset=${tzOffset}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Update stats cards (with fallbacks)
                document.getElementById('todayVisitors').textContent = data.today?.visitors || 0;
                document.getElementById('todaySearches').textContent = data.today?.searches || 0;
                document.getElementById('todayClicks').textContent = data.today?.cta_clicks || 0;
                document.getElementById('conversionRate').textContent = (data.conversion_rate || 0) + '%';

                // Update 7-day trend chart
                updateTrendChart(data.last_7_days || []);

                // Update pie chart
                updatePieChart(data.event_breakdown || {});

                // Update recent searches
                updateSearchQueries(data.recent_searches || []);
                
                // Update recent events
                updateRecentEvents(data.recent_events || []);

                // Update refresh indicator
                lastUpdate = new Date();
                updateRefreshIndicator();

                // Hide loading, show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `‚ö†Ô∏è Error loading data: ${error.message}. Retrying in 10 seconds...`;
            }
        }

        function updateTrendChart(dailyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Fill in missing days (show 7 days even if no data)
            // Use local timezone for "today"
            const today = new Date();
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                // Get local date string in YYYY-MM-DD format
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                const dayData = dailyData.find(d => d.date === dateStr);
                last7Days.push({
                    date: dateStr,
                    visitors: dayData ? dayData.visitors : 0,
                    searches: dayData ? dayData.searches : 0
                });
            }

            const labels = last7Days.map(d => {
                const date = new Date(d.date + 'T00:00:00'); // Local midnight
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visitors',
                        data: last7Days.map(d => d.visitors),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Searches',
                        data: last7Days.map(d => d.searches),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888', stepSize: 1 },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function updatePieChart(eventBreakdown) {
            const ctx = document.getElementById('pieChart').getContext('2d');

            // Handle empty or null data
            if (!eventBreakdown || Object.keys(eventBreakdown).length === 0) {
                if (pieChart) {
                    pieChart.destroy();
                }
                // Show placeholder chart with "No data yet"
                pieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Events Yet'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['rgba(255, 255, 255, 0.1)'],
                            borderColor: '#0f0f1e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#666', padding: 15 }
                            }
                        }
                    }
                });
                return;
            }

            const labels = Object.keys(eventBreakdown).map(type => {
                return type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            });
            const data = Object.values(eventBreakdown);

            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#00ff88',
                            '#ffc107',
                            '#ff4444',
                            '#4444ff',
                            '#ff44ff'
                        ],
                        borderColor: '#0f0f1e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#e0e0e0', padding: 15 }
                        }
                    }
                }
            });
        }

        function updateSearchQueries(searches) {
            const container = document.getElementById('queryList');

            if (!searches || searches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No search queries yet. Waiting for visitors...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = searches.map(search => {
                const timeAgo = getTimeAgo(new Date(search.timestamp));
                const location = search.city && search.country 
                    ? `${search.city}, ${search.country}` 
                    : 'Unknown';
                const page = search.page || 'honeypot';
                const pageLabel = page === 'honeypot' ? 'üçØ Honeypot' : `üìÑ ${page}`;
                return `
                    <div class="query-item">
                        <div class="query-text">"${escapeHtml(search.query)}"</div>
                        <div class="query-meta">
                            <span class="query-location">üìç ${escapeHtml(location)}</span>
                            <span class="query-page">${pageLabel}</span>
                            <span class="query-time">${timeAgo}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRecentEvents(events) {
            const container = document.getElementById('eventList');
            if (!container) return;

            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No events yet today.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => {
                const timeAgo = getTimeAgo(new Date(event.timestamp));
                const location = event.city && event.country 
                    ? `${event.city}, ${event.country}` 
                    : 'Unknown';
                const page = event.page || 'honeypot';
                const pageLabel = page === 'honeypot' ? 'üçØ Honeypot' : `üìÑ ${page}`;
                const eventIcon = {
                    'page_view': 'üëÅÔ∏è',
                    'search': 'üîç',
                    'cta_click': 'üéØ',
                    'result_click': 'üîó'
                }[event.event_type] || 'üìå';
                
                return `
                    <div class="event-item">
                        <span class="event-icon">${eventIcon}</span>
                        <span class="event-type">${event.event_type.replace('_', ' ')}</span>
                        <span class="event-page">${pageLabel}</span>
                        <span class="event-location">üìç ${escapeHtml(location)}</span>
                        <span class="event-time">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const localDate = new Date(date); // Automatically converts UTC to local time
            const seconds = Math.floor((now - localDate) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateRefreshIndicator() {
            if (!lastUpdate) return;
            const timeStr = lastUpdate.toLocaleTimeString();
            document.getElementById('refreshStatus').textContent = `Last updated: ${timeStr}`;
        }

        // Display user's timezone
        function displayTimezone() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const now = new Date();
                const offset = -now.getTimezoneOffset() / 60;
                const offsetStr = offset >= 0 ? `+${offset}` : offset;
                document.getElementById('timezoneInfo').textContent = 
                    `Times shown in your local timezone (${timezone}, UTC${offsetStr})`;
            } catch (e) {
                // Fallback if timezone detection fails
                document.getElementById('timezoneInfo').textContent = 
                    'Times shown in your local timezone';
            }
        }

        // Fetch PyPI download stats
        async function fetchPyPIStats() {
            try {
                // far-search-tool
                const searchResp = await fetch('https://pypistats.org/api/packages/far-search-tool/recent');
                if (searchResp.ok) {
                    const data = await searchResp.json();
                    document.getElementById('farSearchWeek').textContent = data.data?.last_week || '--';
                    const searchMonth = data.data?.last_month || 0;
                    updateMonthlyTotal(searchMonth, 'search');
                }
            } catch (e) {
                console.warn('Failed to fetch far-search-tool stats:', e);
            }
            
            try {
                // far-oracle (with delay to avoid rate limiting)
                await new Promise(r => setTimeout(r, 1000));
                const oracleResp = await fetch('https://pypistats.org/api/packages/far-oracle/recent');
                if (oracleResp.ok) {
                    const data = await oracleResp.json();
                    document.getElementById('farOracleWeek').textContent = data.data?.last_week || '--';
                    const oracleMonth = data.data?.last_month || 0;
                    updateMonthlyTotal(oracleMonth, 'oracle');
                }
            } catch (e) {
                console.warn('Failed to fetch far-oracle stats:', e);
            }
        }
        
        let monthlyTotals = { search: 0, oracle: 0 };
        function updateMonthlyTotal(value, type) {
            monthlyTotals[type] = value;
            const total = monthlyTotals.search + monthlyTotals.oracle;
            document.getElementById('totalMonthly').textContent = total;
        }
        
        // Fetch registered FAR users
        async function fetchRegisteredUsers() {
            try {
                const resp = await fetch(`${API_URL}/v1/customers/count`);
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('registeredUsers').textContent = data.count || '--';
                }
            } catch (e) {
                // Fallback: try to get from database via a simple count query
                console.warn('Could not fetch registered users count');
            }
        }

        // Initialize dashboard
        displayTimezone();
        fetchDashboardData();
        fetchPyPIStats();
        fetchRegisteredUsers();
    </script>
</body>
</html>


