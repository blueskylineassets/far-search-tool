<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAR Search Tool - Internal Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: linear-gradient(135deg, #0a0a14 0%, #12121e 50%, #0a0a14 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
        }

        h1 {
            font-size: 2.2rem;
            color: #64b4ff;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(100, 180, 255, 0.3);
        }

        .subtitle { color: #666; font-size: 0.9rem; }

        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(100, 180, 255, 0.1);
            border: 1px solid rgba(100, 180, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-indicator:hover {
            background: rgba(100, 180, 255, 0.2);
            border-color: #64b4ff;
        }

        .section-title {
            font-size: 1rem;
            color: #64b4ff;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .section-description {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(100, 180, 255, 0.4);
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            color: #999;
            line-height: 1.5;
        }

        .section-description code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
            color: #64b4ff;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .section-description strong { color: #e0e0e0; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(100, 180, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: rgba(100, 180, 255, 0.4);
            transform: translateY(-2px);
        }

        .stat-card.highlight {
            border-color: rgba(100, 180, 255, 0.5);
            background: rgba(100, 180, 255, 0.05);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #64b4ff;
        }

        .stat-detail {
            font-size: 0.7rem;
            color: #666;
            margin-top: 5px;
        }

        section { margin-bottom: 40px; }

        /* Customer Table */
        .customer-table-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .customer-table th {
            text-align: left;
            padding: 12px 15px;
            background: rgba(100, 180, 255, 0.05);
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(100, 180, 255, 0.2);
        }

        .customer-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        .customer-table tr:hover { background: rgba(100, 180, 255, 0.03); }

        .customer-name { font-weight: 600; color: #64b4ff; }
        .customer-email { color: #666; font-size: 0.75rem; }

        .plan-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .plan-free { background: rgba(100, 180, 255, 0.2); color: #64b4ff; }
        .plan-pro { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .plan-ultra { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }

        .source-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            text-transform: lowercase;
            font-weight: 500;
        }

        .source-far-search-tool { background: rgba(100, 180, 255, 0.2); color: #64b4ff; }
        .source-far-oracle { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .source-direct { background: rgba(255, 255, 255, 0.1); color: #888; }

        .status-active { color: #00ff88; }
        .status-trial { color: #ffc832; }

        /* Chart */
        .chart-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper { height: 250px; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading { animation: pulse 1.5s infinite; }

        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid rgba(100, 180, 255, 0.1);
            text-align: center;
            font-size: 0.75rem;
            color: #444;
        }

        footer a { color: #64b4ff; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö FAR Search Tool - Internal Dashboard</h1>
            <p class="subtitle">Real-time metrics for the FAR RAG ecosystem</p>
            <div class="refresh-indicator" onclick="loadAllData()">
                <span id="lastUpdated">Loading...</span>
                <span>üîÑ Refresh</span>
            </div>
        </header>

        <!-- PyPI Downloads -->
        <section>
            <h2 class="section-title">üì¶ PyPI Downloads ‚Äî Public Install Count</h2>
            <p class="section-description">
                ‚ö†Ô∏è <strong>What this means:</strong> Anyone who ran <code>pip install</code>.
                Includes CI/CD bots, mirrors, and people testing locally.
                <strong>Does NOT require registration.</strong>
            </p>
            <div class="stats-grid" id="pypiDownloads">
                <div class="loading">Loading PyPI data...</div>
            </div>
        </section>

        <!-- Registered Customers -->
        <section>
            <h2 class="section-title">üë• Registered Customers ‚Äî Three-Tier System</h2>
            <p class="section-description">
                <strong>Three account types:</strong><br>
                üöÄ <strong>Production</strong> ‚Äî Deployed on cloud/servers (your goal metric)<br>
                üß™ <strong>Trial</strong> ‚Äî Developers evaluating on laptops (your conversion funnel)<br>
                üîß <strong>Test</strong> ‚Äî Your internal tests (hidden from metrics)
            </p>
            <div class="stats-grid" id="customerMetrics">
                <div class="loading">Loading metrics...</div>
            </div>
        </section>

        <!-- Customer Details -->
        <section>
            <h3 class="section-title">üìã Customer Details</h3>
            <div class="customer-table-container">
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Agent/Company</th>
                            <th>Source</th>
                            <th>Plan</th>
                            <th>Usage</th>
                            <th>Status</th>
                            <th>Registered</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <tr><td colspan="6" class="loading">Loading customers...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Conversion Funnel -->
        <section>
            <h2 class="section-title">üîÑ Conversion Funnel ‚Äî Downloads ‚Üí Customers ‚Üí Usage</h2>
            <p class="section-description">
                üìä <strong>How to read this:</strong> Downloads are <em>awareness</em>,
                Registrations are <em>activation</em>, Queries are <em>engagement</em>.
            </p>
            <div class="stats-grid" id="conversionFunnel">
                <div class="loading">Loading funnel data...</div>
            </div>
        </section>

        <!-- Download Trends -->
        <section>
            <h2 class="section-title">üìà Download Trends (7 Days)</h2>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="downloadChart"></canvas>
                </div>
            </div>
        </section>

        <!-- API Usage -->
        <section>
            <h2 class="section-title">üìä API Usage & Queries</h2>
            <div class="stats-grid" id="apiUsage">
                <div class="loading">Loading usage data...</div>
            </div>
        </section>

        <footer>
            <a href="https://pypi.org/project/far-search-tool/" target="_blank">PyPI</a>
            <span style="color: rgba(255,255,255,0.2);">|</span>
            <a href="https://github.com/blueskylineassets/far-search-tool" target="_blank">GitHub</a>
            <span style="color: rgba(255,255,255,0.2);">|</span>
            <a href="https://rapidapi.com/yschang/api/far-rag-federal-acquisition-regulation-search" target="_blank">RapidAPI</a>
            <br><br>
            FAR Search Tool ¬© 2024. All rights reserved.
        </footer>
    </div>

    <script>
        const API_URL = 'https://far-rag-api-production.up.railway.app';
        
        let downloadChart = null;

        async function loadAllData() {
            document.getElementById('lastUpdated').textContent = 'Refreshing...';
            
            try {
                await Promise.all([
                    loadPyPIStats(),
                    loadCustomerMetrics(),
                    loadCustomers(),
                    loadApiUsage()
                ]);
                
                document.getElementById('lastUpdated').textContent = 
                    `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('Failed to load data:', e);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            }
        }

        async function loadPyPIStats() {
            try {
                const response = await fetch(`${API_URL}/v1/pypi-stats`);
                if (!response.ok) throw new Error('PyPI stats failed');
                
                const data = await response.json();
                const pypi = data.pypi_downloads || {};
                
                const searchData = pypi['far-search-tool'] || {};
                const oracleData = pypi['far-oracle'] || {};
                
                document.getElementById('pypiDownloads').innerHTML = `
                    <div class="stat-card highlight">
                        <div class="stat-label">far-search-tool (PyPI)</div>
                        <div class="stat-value">${searchData.week || 0}</div>
                        <div class="stat-detail">${searchData.month || 0}/month ¬∑ LangChain Tool</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">far-oracle (PyPI)</div>
                        <div class="stat-value">${oracleData.week || 0}</div>
                        <div class="stat-detail">${oracleData.month || 0}/month ¬∑ MCP Server</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Monthly</div>
                        <div class="stat-value">${data.total_monthly || 0}</div>
                        <div class="stat-detail">All FAR packages</div>
                    </div>
                `;
                
                // Update conversion funnel with download data
                updateConversionFunnel(data.total_monthly || 0);
                
            } catch (e) {
                console.error('PyPI stats error:', e);
                document.getElementById('pypiDownloads').innerHTML = 
                    '<div class="stat-card"><div class="stat-value">--</div><div class="stat-detail">Failed to load</div></div>';
            }
        }

        async function loadCustomerMetrics() {
            try {
                const response = await fetch(`${API_URL}/v1/customers/count`);
                if (!response.ok) throw new Error('Customer count failed');
                
                const data = await response.json();
                const bySource = data.by_source || {};
                
                // Calculate tiers (simplified - all are "trial" unless marked)
                const total = data.count || 0;
                const farSearchTool = bySource['far-search-tool'] || 0;
                const farOracle = bySource['far-oracle'] || 0;
                const direct = bySource['direct'] || 0;
                
                document.getElementById('customerMetrics').innerHTML = `
                    <div class="stat-card highlight">
                        <div class="stat-label">üöÄ Total Registered</div>
                        <div class="stat-value">${total}</div>
                        <div class="stat-detail">All FAR API users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üì¶ far-search-tool</div>
                        <div class="stat-value" style="color: #64b4ff;">${farSearchTool}</div>
                        <div class="stat-detail">LangChain users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üîÆ far-oracle</div>
                        <div class="stat-value" style="color: #3b82f6;">${farOracle}</div>
                        <div class="stat-detail">MCP Server users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üîó Direct API</div>
                        <div class="stat-value" style="color: #888;">${direct}</div>
                        <div class="stat-detail">Direct registrations</div>
                    </div>
                `;
                
                // Store for funnel
                window.totalCustomers = total;
                
            } catch (e) {
                console.error('Customer metrics error:', e);
            }
        }

        async function loadCustomers() {
            try {
                const response = await fetch(`${API_URL}/v1/customers/list`);
                if (!response.ok) throw new Error('Customer list failed');
                
                const data = await response.json();
                const customers = data.customers || [];
                
                if (customers.length === 0) {
                    document.getElementById('customerTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #666;">No customers yet</td></tr>';
                    return;
                }
                
                document.getElementById('customerTableBody').innerHTML = customers.map(c => {
                    const source = c.registration_source || 'direct';
                    const sourceClass = `source-${source.replace(/[^a-z-]/gi, '-')}`;
                    const planClass = `plan-${(c.plan || 'free').toLowerCase()}`;
                    const statusClass = c.billing_status === 'active' ? 'status-active' : 'status-trial';
                    
                    const registered = new Date(c.created_at).toLocaleDateString();
                    const usage = c.queries_used_this_month || 0;
                    const limit = c.queries_per_month || 500;
                    
                    return `
                        <tr>
                            <td>
                                <div class="customer-name">${escapeHtml(c.agent_id || c.company_name || 'Unknown')}</div>
                                <div class="customer-email">${escapeHtml(c.email || '')}</div>
                            </td>
                            <td><span class="source-badge ${sourceClass}">${source}</span></td>
                            <td><span class="plan-badge ${planClass}">${c.plan || 'free'}</span></td>
                            <td>${usage}/${limit}</td>
                            <td class="${statusClass}">${c.billing_status || 'trial'}</td>
                            <td>${registered}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Customer list error:', e);
                document.getElementById('customerTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: #ff6464;">Failed to load customers</td></tr>';
            }
        }

        async function loadApiUsage() {
            try {
                const response = await fetch(`${API_URL}/v1/usage/stats`);
                if (!response.ok) throw new Error('Usage stats failed');
                
                const data = await response.json();
                
                document.getElementById('apiUsage').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Queries Today</div>
                        <div class="stat-value">${data.queries_today || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Queries This Month</div>
                        <div class="stat-value">${data.queries_this_month || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Queries</div>
                        <div class="stat-value">${data.total_queries || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active API Keys</div>
                        <div class="stat-value">${data.active_keys || 0}</div>
                    </div>
                `;
                
                // Store for funnel
                window.totalQueries = data.total_queries || 0;
                
            } catch (e) {
                console.error('Usage stats error:', e);
                document.getElementById('apiUsage').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">API Usage</div>
                        <div class="stat-value">--</div>
                        <div class="stat-detail">Endpoint not available</div>
                    </div>
                `;
            }
        }

        function updateConversionFunnel(downloads) {
            const customers = window.totalCustomers || 0;
            const queries = window.totalQueries || 0;
            
            const regRate = downloads > 0 ? ((customers / downloads) * 100).toFixed(1) : 0;
            const activeRate = customers > 0 ? ((queries > 0 ? customers : 0) / customers * 100).toFixed(0) : 0;
            
            document.getElementById('conversionFunnel').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üì• Downloads</div>
                    <div class="stat-value">${downloads}</div>
                    <div class="stat-detail">Monthly installs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìù Registrations</div>
                    <div class="stat-value">${customers}</div>
                    <div class="stat-detail">${regRate}% conversion</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üîç Active Users</div>
                    <div class="stat-value">${queries > 0 ? customers : 0}</div>
                    <div class="stat-detail">${activeRate}% of registered</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
